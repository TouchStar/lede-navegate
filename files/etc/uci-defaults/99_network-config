. /lib/ar71xx.sh
. /lib/functions/touchstar.sh

board=$(ar71xx_board_name)

logger -t network-config "Applying network configuration [start]"

case "$board" in
ts-vh401)	
		# Defaults
	apn="telstra.internet"

		# Grab configuration from uboot
	populate_ubootvars

		# Determine apn/ssid/host
    ssid=$(format_get ts_ssid "IntelLINK{-auto}")
    host=$(format_get ts_host "il{-auto}")
	tmp_apn=$(apn_get)
	if [ $? == 0 ]; then
        apn=$tmp_apn
	fi	

	logger -t network-config "Determined SSID=[$ssid] Hostname[$host] APN[$apn]"

		# Set system hostname
	uci set system.@system[0].hostname="$host"
	uci commit system

		# Trigger system to restart and capture new hostname.
	/etc/init.d/system restart

		# Rather than disabling rebind protection, let's just allow it for "our" domains.
	uci add_list dhcp.@dnsmasq[0].rebind_domain='touchstar.com.au'
	uci add_list dhcp.@dnsmasq[0].rebind_domain='touchstar.biz'
 	uci commit dhcp
	
		# Enabled wifi and set default SSID (restart once uci is set)
	uci set wireless.@wifi-iface[0].ssid="$ssid"
  	uci set wireless.@wifi-device[0].disabled=0
  	uci commit wireless
  	wifi

		# Setup 3g cellular and set APN.
  	uci set network.wan=interface
  	uci set network.wan.proto='3g'
  	uci set network.wan.device='/dev/ttyUSB3'
  	uci set network.wan.service='umts'
 	uci set network.wan.apn="$apn"

 		# Setup AutoSSH
 	autossh_port=$(($serial + 10000))

	uci set autossh.@autossh[0].ssh="-i /etc/dropbear/id_rsa -N -T -R *:$autossh_port:localhost:22 device@machine20.touchstar.com.au"
	uci set autossh.@autossh[0].monitorport='0'
  	uci set autossh.@autossh[0].poll='300'
	uci commit autossh 	

		# disable ipv6 for test network given issues on TS network with device becoming primary dns resolved for link-local.
  	uci delete network.ts6
  	uci commit network 	
	;;
esac

logger -t network-config "Applying Network Configuration [end]"
